<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zahir Global Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B5FBF;
            --primary-dark: #7B4BB7;
            --primary-light: #9C75CF;
            --secondary: #C445F4;
            --accent: #E879F9;
            --dark: #1E1B2E;
            --light: #F8FAFC;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #2D1B69 100%);
            min-height: 100vh;
            color: white;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            margin: auto;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 40px;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .auth-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 25px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-light);
        }

        .input-group input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
        }

        .input-group input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 95, 191, 0.4);
        }

        .lobby-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .admin-badge {
            background: var(--warning);
            color: var(--dark);
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: var(--error);
        }

        .lobby-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .create-room-btn, .join-room-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .create-room-btn:hover, .join-room-btn:hover {
            transform: translateY(-2px);
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .room-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .room-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .room-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .room-code {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            display: inline-block;
        }

        .room-desc {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-bottom: 10px;
        }

        .room-meta {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .delete-room-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--error);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }

        .room-card:hover .delete-room-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container {
            width: 100%;
            max-width: 1000px;
            height: 100vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
        }

        .room-actions {
            display: flex;
            gap: 10px;
        }

        .room-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .clear-chat-btn {
            background: var(--warning);
        }

        .clear-chat-btn:hover {
            background: #e67e22;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 15px;
            position: relative;
        }

        .message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .message.other {
            align-self: flex-start;
            border: 2px solid;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .user-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .message-sender {
            font-weight: 600;
            font-size: 12px;
            opacity: 0.9;
        }

        .message-content {
            font-size: 14px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            text-align: right;
            margin-top: 5px;
        }

        /* Kullanıcı renkleri */
        .user-color-1 { border-color: #FF6B6B; background: rgba(255, 107, 107, 0.15); }
        .user-color-2 { border-color: #4ECDC4; background: rgba(78, 205, 196, 0.15); }
        .user-color-3 { border-color: #45B7D1; background: rgba(69, 183, 209, 0.15); }
        .user-color-4 { border-color: #96CEB4; background: rgba(150, 206, 180, 0.15); }
        .user-color-5 { border-color: #FFEAA7; background: rgba(255, 234, 167, 0.15); }
        .user-color-6 { border-color: #DDA0DD; background: rgba(221, 160, 221, 0.15); }
        .user-color-7 { border-color: #98D8C8; background: rgba(152, 216, 200, 0.15); }
        .user-color-8 { border-color: #F7DC6F; background: rgba(247, 220, 111, 0.15); }

        /* Logo renkleri */
        .logo-color-1 { background: #FF6B6B; }
        .logo-color-2 { background: #4ECDC4; }
        .logo-color-3 { background: #45B7D1; }
        .logo-color-4 { background: #96CEB4; }
        .logo-color-5 { background: #FFEAA7; color: #333; }
        .logo-color-6 { background: #DDA0DD; }
        .logo-color-7 { background: #98D8C8; }
        .logo-color-8 { background: #F7DC6F; color: #333; }

        .chat-input-container {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .message-input-wrapper input {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
        }

        .send-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-primary {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .btn-danger {
            padding: 12px 25px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .no-rooms {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 16px;
        }

        .room-code-display {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 24px;
            letter-spacing: 3px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
        }

        .connected {
            background: var(--success);
        }

        .disconnected {
            background: var(--error);
        }

        .notification {
            position: fixed;
            top: 50px;
            right: 10px;
            padding: 12px 16px;
            background: var(--warning);
            color: var(--dark);
            border-radius: 10px;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Bağlantı Durumu -->
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-wifi"></i> Bağlantı Yok
    </div>

    <!-- Giriş Ekranı -->
    <div id="loginScreen" class="screen active">
        <div class="auth-container">
            <div class="auth-header">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <h1>Zahir Chat</h1>
                </div>
                <p>Oda Kodu ile Gizli Sohbet</p>
            </div>

            <div class="auth-tabs">
                <button class="tab-btn active" onclick="showTab('login')">Giriş Yap</button>
                <button class="tab-btn" onclick="showTab('register')">Kayıt Ol</button>
            </div>

            <div id="loginForm" class="auth-form active">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="loginUsername" placeholder="Kullanıcı adı">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPassword" placeholder="Şifre">
                </div>
                <button class="auth-btn" onclick="login()">
                    <i class="fas fa-sign-in-alt"></i>
                    Giriş Yap
                </button>
            </div>

            <div id="registerForm" class="auth-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="regUsername" placeholder="Kullanıcı adı">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="regPassword" placeholder="Şifre">
                </div>
                <button class="auth-btn" onclick="register()">
                    <i class="fas fa-user-plus"></i>
                    Hesap Oluştur
                </button>
            </div>
        </div>
    </div>

    <!-- Oda Listesi -->
    <div id="lobbyScreen" class="screen">
        <div class="lobby-container">
            <div class="lobby-header">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 id="welcomeUser">Kullanıcı</h3>
                        <span>Çevrimiçi</span>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>

            <div class="lobby-actions">
                <button class="create-room-btn" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i>
                    Oda Oluştur
                </button>
                <button class="join-room-btn" onclick="showJoinModal()">
                    <i class="fas fa-sign-in-alt"></i>
                    Odaya Katıl
                </button>
            </div>

            <div class="rooms-section">
                <h4>Katıldığım Odalar</h4>
                <div class="rooms-grid" id="roomsList">
                    <!-- Odalar buraya gelecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Sohbet Ekranı -->
    <div id="chatScreen" class="screen">
        <div class="chat-container">
            <div class="chat-header">
                <div class="room-info">
                    <button class="back-btn" onclick="leaveRoom()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h3 id="roomName">Oda İsmi</h3>
                        <span id="roomMembers">0 üye</span>
                    </div>
                </div>
                <div class="room-actions">
                    <button class="room-action-btn" onclick="showRoomCode()" title="Oda Kodunu Göster">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="room-action-btn clear-chat-btn" id="clearChatBtn" onclick="clearChat()" title="Sohbeti Temizle" style="display: none;">
                        <i class="fas fa-broom"></i>
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Mesajlar buraya gelecek -->
            </div>

            <div class="chat-input-container">
                <div class="message-input-wrapper">
                    <input type="text" id="messageInput" placeholder="Mesajınızı yazın..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Oda Oluşturma Modal -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Yeni Oda Oluştur</h3>
                <button class="close-modal" onclick="hideCreateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="roomNameInput" placeholder="Oda ismi">
                </div>
                <div class="input-group">
                    <input type="text" id="roomDescInput" placeholder="Oda açıklaması">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="hideCreateModal()">İptal</button>
                <button class="btn-primary" onclick="createRoom()">Oluştur</button>
            </div>
        </div>
    </div>

    <!-- Odaya Katılma Modal -->
    <div id="joinRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Odaya Katıl</h3>
                <button class="close-modal" onclick="hideJoinModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <input type="text" id="roomCodeInput" placeholder="Oda kodunu girin (5 haneli)" maxlength="5" style="text-transform: uppercase;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="hideJoinModal()">İptal</button>
                <button class="btn-primary" onclick="joinRoomByCode()">Katıl</button>
            </div>
        </div>
    </div>

    <!-- Oda Kodu Göster Modal -->
    <div id="roomCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Oda Kodu</h3>
                <button class="close-modal" onclick="hideRoomCodeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="room-code-display" id="roomCodeDisplay">
                    ABC12
                </div>
                <p style="text-align: center; color: rgba(255,255,255,0.7);">
                    Bu kodu arkadaşlarınızla paylaşarak odanıza katılmalarını sağlayabilirsiniz.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="hideRoomCodeModal()">Tamam</button>
            </div>
        </div>
    </div>

    <script>
        // Socket.io bağlantısı - LOCAL için
        const socket = io('http://localhost:3000');
        
        // Vercel/Netlify için:
        // const socket = io('https://zahir-chat-backend.vercel.app');

        let currentUser = null;
        let currentRoom = null;
        let userColors = JSON.parse(localStorage.getItem('userColors') || '{}');

        // Renk paleti
        const colorPalette = [1, 2, 3, 4, 5, 6, 7, 8];

        // Socket event listeners
        socket.on('connect', () => {
            console.log('✅ Sunucuya bağlandı');
            updateConnectionStatus(true);
            
            // Eğer önceden giriş yapılmışsa, otomatik giriş
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                socket.emit('user_login', { username: currentUser });
                document.getElementById('welcomeUser').textContent = currentUser;
                showScreen('lobbyScreen');
            }
        });

        socket.on('disconnect', () => {
            console.log('❌ Sunucu bağlantısı kesildi');
            updateConnectionStatus(false);
        });

        socket.on('room_created', (data) => {
            showNotification(`🎯 Oda oluşturuldu! Kod: ${data.roomCode}`);
            hideCreateModal();
            joinRoom(data.room);
        });

        socket.on('room_joined', (data) => {
            hideJoinModal();
            joinRoom(data.room);
            loadMessages(data.messages);
        });

        socket.on('room_not_found', (data) => {
            alert(data.message);
        });

        socket.on('new_message', (message) => {
            addMessageToChat(message);
        });

        socket.on('room_updated', (room) => {
            if (currentRoom && currentRoom.code === room.code) {
                currentRoom = room;
                document.getElementById('roomMembers').textContent = `${room.members.length} üye`;
            }
        });

        socket.on('user_joined', (data) => {
            if (currentRoom) {
                showNotification(`👤 ${data.username} odaya katıldı`);
            }
        });

        socket.on('user_left', (data) => {
            if (currentRoom) {
                showNotification(`👤 ${data.username} odadan ayrıldı`);
            }
        });

        socket.on('chat_cleared', () => {
            document.getElementById('chatMessages').innerHTML = '';
            showNotification('🧹 Sohbet temizlendi');
        });

        socket.on('clear_chat_error', (data) => {
            alert(data.message);
        });

        socket.on('user_rooms', (rooms) => {
            loadRooms(rooms);
        });

        // Bağlantı durumu güncelleme
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.innerHTML = '<i class="fas fa-wifi"></i> Bağlı';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i> Bağlantı Yok';
                statusElement.className = 'connection-status disconnected';
            }
        }

        // Bildirim göster
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Kullanıcı rengi al
        function getUserColor(username) {
            if (!userColors[username]) {
                const usedColors = Object.values(userColors);
                let availableColors = colorPalette.filter(color => !usedColors.includes(color));
                if (availableColors.length === 0) {
                    availableColors = colorPalette;
                }
                const randomColor = availableColors[Math.floor(Math.random() * availableColors.length)];
                userColors[username] = randomColor;
                localStorage.setItem('userColors', JSON.stringify(userColors));
            }
            return userColors[username];
        }

        // Kullanıcı logo harfi al
        function getUserLogo(username) {
            return username.charAt(0).toUpperCase();
        }

        // Tab değiştirme
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            
            if (tabName === 'login') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        // Giriş yap
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Kullanıcı adı ve şifre gerekli!');
                return;
            }

            // Basit doğrulama (gerçek uygulamada backend'de yapılır)
            const users = JSON.parse(localStorage.getItem('chatUsers') || '{}');
            if (users[username] && users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                socket.emit('user_login', { username: username });
                document.getElementById('welcomeUser').textContent = username;
                showScreen('lobbyScreen');
                
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            } else {
                alert('Hatalı kullanıcı adı veya şifre!');
            }
        }

        // Kayıt ol
        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!username || !password) {
                alert('Kullanıcı adı ve şifre gerekli!');
                return;
            }

            if (password.length < 4) {
                alert('Şifre en az 4 karakter olmalı!');
                return;
            }

            const users = JSON.parse(localStorage.getItem('chatUsers') || '{}');
            if (users[username]) {
                alert('Bu kullanıcı adı zaten alınmış!');
                return;
            }

            users[username] = {
                password: password,
                email: '',
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('chatUsers', JSON.stringify(users));
            
            alert('Hesap oluşturuldu! Giriş yapabilirsin.');
            showTab('login');
            
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
        }

        // Çıkış yap
        function logout() {
            if (currentRoom) {
                socket.emit('leave_room');
            }
            currentUser = null;
            localStorage.removeItem('currentUser');
            currentRoom = null;
            showScreen('loginScreen');
        }

        // Ekran değiştirme
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Modal fonksiyonları
        function showCreateModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }

        function hideCreateModal() {
            document.getElementById('createRoomModal').classList.remove('active');
        }

        function showJoinModal() {
            document.getElementById('joinRoomModal').classList.add('active');
        }

        function hideJoinModal() {
            document.getElementById('joinRoomModal').classList.remove('active');
        }

        function showRoomCode() {
            if (!currentRoom) return;
            document.getElementById('roomCodeDisplay').textContent = currentRoom.code;
            document.getElementById('roomCodeModal').classList.add('active');
        }

        function hideRoomCodeModal() {
            document.getElementById('roomCodeModal').classList.remove('active');
        }

        // Oda oluştur
        function createRoom() {
            const name = document.getElementById('roomNameInput').value.trim();
            const desc = document.getElementById('roomDescInput').value.trim();
            
            if (!name) {
                alert('Oda ismi gerekli!');
                return;
            }

            socket.emit('create_room', {
                name: name,
                description: desc || 'Açıklama yok'
            });
            
            document.getElementById('roomNameInput').value = '';
            document.getElementById('roomDescInput').value = '';
        }

        // Oda koduna göre katıl
        function joinRoomByCode() {
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!roomCode) {
                alert('Oda kodu gerekli!');
                return;
            }

            if (roomCode.length !== 5) {
                alert('Oda kodu 5 haneli olmalı!');
                return;
            }

            socket.emit('join_room', { roomCode: roomCode });
            document.getElementById('roomCodeInput').value = '';
        }

        // Sohbeti temizle
        function clearChat() {
            if (!currentRoom) return;
            socket.emit('clear_chat');
        }

        // Odaları yükle
        function loadRooms(rooms) {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';

            if (!rooms || rooms.length === 0) {
                roomsList.innerHTML = '<div class="no-rooms">Henüz hiç odaya katılmadınız. Oda oluşturun veya bir odaya katılın!</div>';
                return;
            }

            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                roomCard.onclick = () => joinRoom(room);
                
                roomCard.innerHTML = `
                    <div class="room-code">${room.code}</div>
                    <div class="room-name">${room.name}</div>
                    <div class="room-desc">${room.description}</div>
                    <div class="room-meta">
                        <span>${room.members.length} üye</span>
                        <span>${room.creator}</span>
                    </div>
                `;
                
                roomsList.appendChild(roomCard);
            });
        }

        // Odaya katıl
        function joinRoom(room) {
            currentRoom = room;
            document.getElementById('roomName').textContent = room.name;
            document.getElementById('roomMembers').textContent = `${room.members.length} üye`;

            const clearChatBtn = document.getElementById('clearChatBtn');
            clearChatBtn.style.display = (room.creator === currentUser) ? 'block' : 'none';

            showScreen('chatScreen');
            document.getElementById('chatMessages').innerHTML = '';
        }

        // Mesaj gönder
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentRoom) return;

            socket.emit('send_message', { text: text });
            input.value = '';
        }

        // Mesajı chat'e ekle
        function addMessageToChat(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            const isOwnMessage = message.sender === currentUser;
            const userColor = getUserColor(message.sender);
            const userLogo = getUserLogo(message.sender);
            
            messageDiv.className = `message ${isOwnMessage ? 'own' : 'other'} user-color-${userColor}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                ${!isOwnMessage ? `
                    <div class="message-header">
                        <div class="user-logo logo-color-${userColor}">
                            ${userLogo}
                        </div>
                        <div class="message-sender">${message.sender}</div>
                    </div>
                ` : ''}
                <div class="message-content">${message.text}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Mesajları yükle
        function loadMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            if (!messages || messages.length === 0) return;

            messages.forEach(message => {
                addMessageToChat(message);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Enter tuşu ile mesaj gönder
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Odadan ayrıl
        function leaveRoom() {
            if (currentRoom) {
                socket.emit('leave_room');
                currentRoom = null;
            }
            
            showScreen('lobbyScreen');
        }

        // Sayfa yüklendiğinde
        window.addEventListener('load', function() {
            console.log('🚀 Zahir Chat hazır!');
            
            // Otomatik giriş kontrolü
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                socket.emit('user_login', { username: currentUser });
                document.getElementById('welcomeUser').textContent = currentUser;
                showScreen('lobbyScreen');
            }
        });
    </script>
</body>
</html>
